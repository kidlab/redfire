<?xml version="1.0" encoding="utf-8"?>
<mx:Canvas xmlns:mx="http://www.adobe.com/2006/mxml" width="100%" height="100%" 
	backgroundAlpha="0"
	icon="@Embed('/assets/icon_account.png')"
	label="Customers"
	creationComplete="loadData()">
	
	<mx:Script>
		<![CDATA[

		import com.salesbuilder.control.TabManager;
		import com.salesbuilder.model.Account;
		import com.salesbuilder.dao.AccountDAO;
		import mx.collections.ArrayCollection;
    		import mx.controls.Alert;
		
		[Bindable] private var topAccounts:ArrayCollection;
		[Bindable] private var accounts:ArrayCollection;
		
		private var max:Number = 0;
		
		public function loadData():void
		{
			var dao:AccountDAO = new AccountDAO();
			dao.getTopAccounts(10, function (result:ArrayCollection):void
			{
				if (result)
				{
					topAccounts = result;
					
					for (var i:int=0 ; i<topAccounts.length ; i++)
					{
						var account:Account = topAccounts.getItemAt(i) as Account;
						var total:Number = account.currentYearResults + account.lastYearResults;
						if (total > max)
						{
							max = total; 
						}
					}
					DataGridBarRenderer.max = max;
				}
			});
			
			
			dao.getAccounts(function (result:ArrayCollection):void
			{
				accounts = result;
			});
		}	

		private function getRank(item:Object, column:DataGridColumn):String
		{
			return "" + (topAccounts.getItemIndex(item) + 1);
		}
		
        ]]>

    </mx:Script>

    <mx:CurrencyFormatter id="cf"/>
	
	<mx:HBox width="100%" height="100%" paddingTop="12" paddingBottom="8" paddingLeft="8" paddingRight="8" horizontalGap="20">
		
		<mx:VBox width="60%" height="100%" verticalGap="4">
			
			<mx:Label styleName="title" text="Top 10 Customers"/>
			
			<mx:DataGrid id="dgTop" dataProvider="{topAccounts}" width="100%" height="100%" doubleClickEnabled="true" 
				doubleClick="TabManager.openAccount(dgTop.selectedItem as Account)"
				alternatingItemColors="[#FFFFFF,#FFFFFF]">
				<mx:columns>
					<mx:DataGridColumn labelFunction="getRank" headerText="Rank" width="60"/>
					<mx:DataGridColumn dataField="name" headerText="Customer" width="130"/>
					<mx:DataGridColumn itemRenderer="com.salesbuilder.view.DataGridBarRenderer" dataField="currentYearResults" headerText="Yearly Revenue (Last / Current)"/>
				</mx:columns>
			</mx:DataGrid>
			
			<mx:Spacer height="8"/>
			
			<mx:Label styleName="title" text="Recent Activity"/>
	
			<mx:DataGrid width="100%" height="100%">
				<mx:columns>
					<mx:DataGridColumn dataField="name" headerText="Customer"/>
					<mx:DataGridColumn dataField="date" headerText="Date"/>
					<mx:DataGridColumn dataField="author" headerText="Agent"/>
				</mx:columns>
			</mx:DataGrid>
	
		</mx:VBox>

		<mx:VBox width="40%" height="100%" verticalGap="4">
			
			<mx:Label styleName="title" text="All Customers"/>
			
			<mx:DataGrid id="dgAll" dataProvider="{accounts}" width="100%" height="100%" doubleClickEnabled="true" doubleClick="TabManager.openAccount(dgAll.selectedItem as Account)"
				alternatingItemColors="[#FFFFFF,#FFFFFF]">
				<mx:columns>
					<mx:DataGridColumn dataField="name" headerText="Name"/>
					<mx:DataGridColumn dataField="city" headerText="City"/>
					<mx:DataGridColumn dataField="phone" headerText="Phone"/>
				</mx:columns>
			</mx:DataGrid>
			
		</mx:VBox>

	</mx:HBox>
	
</mx:Canvas>
